#!/bin/bash
# LevitateOS Installer - Installs the live system to disk

set -e

echo "=========================================="
echo "  LevitateOS Installer"
echo "=========================================="
echo

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: This installer must be run as root."
    exit 1
fi

# List available disks
echo "Available disks:"
echo
lsblk -d -o NAME,SIZE,MODEL | grep -v "loop\|sr\|NAME"
echo

read -p "Enter target disk (e.g., sda, nvme0n1): " TARGET_DISK

if [ -z "$TARGET_DISK" ]; then
    echo "Error: No disk specified."
    exit 1
fi

TARGET="/dev/$TARGET_DISK"

if [ ! -b "$TARGET" ]; then
    echo "Error: $TARGET is not a valid block device."
    exit 1
fi

echo
echo "WARNING: This will ERASE ALL DATA on $TARGET"
echo
read -p "Type 'yes' to continue: " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Installation cancelled."
    exit 1
fi

echo
echo "==> Partitioning $TARGET..."

# Create GPT partition table with EFI and root partitions
parted -s "$TARGET" mklabel gpt
parted -s "$TARGET" mkpart ESP fat32 1MiB 512MiB
parted -s "$TARGET" set 1 esp on
parted -s "$TARGET" mkpart root ext4 512MiB 100%

# Determine partition names (nvme vs sda style)
if [[ "$TARGET" == *"nvme"* ]]; then
    EFI_PART="${TARGET}p1"
    ROOT_PART="${TARGET}p2"
else
    EFI_PART="${TARGET}1"
    ROOT_PART="${TARGET}2"
fi

echo "==> Formatting partitions..."
mkfs.fat -F32 "$EFI_PART"
mkfs.ext4 -F "$ROOT_PART"

echo "==> Mounting partitions..."
MOUNT_ROOT="/mnt/levitateos"
mkdir -p "$MOUNT_ROOT"
mount "$ROOT_PART" "$MOUNT_ROOT"
mkdir -p "$MOUNT_ROOT/boot/efi"
mount "$EFI_PART" "$MOUNT_ROOT/boot/efi"

echo "==> Copying system files..."
# Copy from live squashfs to target
rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / "$MOUNT_ROOT/"

echo "==> Installing bootloader..."
# Bind mount for chroot
mount --bind /dev "$MOUNT_ROOT/dev"
mount --bind /proc "$MOUNT_ROOT/proc"
mount --bind /sys "$MOUNT_ROOT/sys"

# Install GRUB
chroot "$MOUNT_ROOT" grub2-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=LevitateOS --recheck
chroot "$MOUNT_ROOT" grub2-mkconfig -o /boot/grub2/grub.cfg

# Generate fstab
ROOT_UUID=$(blkid -s UUID -o value "$ROOT_PART")
EFI_UUID=$(blkid -s UUID -o value "$EFI_PART")

cat > "$MOUNT_ROOT/etc/fstab" << EOF
# /etc/fstab - LevitateOS
UUID=$ROOT_UUID  /          ext4  defaults  0 1
UUID=$EFI_UUID   /boot/efi  vfat  umask=0077  0 2
EOF

# Disable autologin on installed system
rm -f "$MOUNT_ROOT/etc/systemd/system/getty@tty1.service.d/autologin.conf"

echo "==> Cleaning up..."
umount "$MOUNT_ROOT/dev"
umount "$MOUNT_ROOT/proc"
umount "$MOUNT_ROOT/sys"
umount "$MOUNT_ROOT/boot/efi"
umount "$MOUNT_ROOT"

echo
echo "=========================================="
echo "  Installation complete!"
echo "=========================================="
echo
echo "You can now reboot into your new LevitateOS installation."
echo "Run: reboot"
