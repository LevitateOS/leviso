#!/bin/bash
# Init script for LevitateOS Live
# Mounts essential filesystems then execs systemd

export PATH=/bin:/sbin:/usr/bin:/usr/sbin

echo "[init] Starting LevitateOS init..."

# Mount essential filesystems
echo "[init] Mounting proc..."
/bin/mount -t proc proc /proc
echo "[init] Mounting sysfs..."
/bin/mount -t sysfs sys /sys
echo "[init] Mounting devtmpfs..."
/bin/mount -t devtmpfs dev /dev

# Create /dev nodes that might be missing
/bin/mkdir -p /dev/pts
/bin/mount -t devpts devpts /dev/pts

# Create and mount /run (systemd needs this)
/bin/mkdir -p /run
/bin/mount -t tmpfs -o mode=755 tmpfs /run

# /var/run should be symlink to /run
/bin/ln -sf /run /var/run

# Mount cgroups (systemd needs this for service management)
/bin/mkdir -p /sys/fs/cgroup
/bin/mount -t cgroup2 cgroup2 /sys/fs/cgroup 2>/dev/null || \
    /bin/mount -t tmpfs cgroup /sys/fs/cgroup  # fallback if cgroup2 not supported

# Mount efivarfs if booted in UEFI mode
if [ -d /sys/firmware/efi/efivars ]; then
    /bin/mount -t efivarfs efivarfs /sys/firmware/efi/efivars
fi

# Load CPU microcode for security patches (before other modules)
echo "[init] Loading CPU microcode..."
if [ -d /lib/firmware/intel-ucode ] && grep -q GenuineIntel /proc/cpuinfo 2>/dev/null; then
    # Intel microcode - loaded via /dev/cpu/microcode
    if [ -c /dev/cpu/microcode ]; then
        for ucode in /lib/firmware/intel-ucode/*; do
            [ -f "$ucode" ] && cat "$ucode" > /dev/cpu/microcode 2>/dev/null
        done
        echo "[init] Intel microcode loaded"
    else
        echo "[init] Intel microcode: /dev/cpu/microcode not available (kernel may auto-load)"
    fi
elif [ -d /lib/firmware/amd-ucode ] && grep -q AuthenticAMD /proc/cpuinfo 2>/dev/null; then
    # AMD microcode - loaded via /dev/cpu/microcode
    if [ -c /dev/cpu/microcode ]; then
        for ucode in /lib/firmware/amd-ucode/*; do
            [ -f "$ucode" ] && cat "$ucode" > /dev/cpu/microcode 2>/dev/null
        done
        echo "[init] AMD microcode loaded"
    else
        echo "[init] AMD microcode: /dev/cpu/microcode not available (kernel may auto-load)"
    fi
else
    echo "[init] No CPU microcode found (install linux-firmware for security patches)"
fi

# Load essential kernel modules using modprobe (handles dependencies automatically)
echo "[init] Loading kernel modules..."
KVER=$(ls /lib/modules/ 2>/dev/null | head -1)
if [ -n "$KVER" ]; then
    # modprobe automatically resolves dependencies from modules.dep
    # No need for manual ordering - just load what we need
    load_module() {
        local mod="$1"
        if modprobe "$mod" 2>/dev/null; then
            echo "[init] Loaded $mod"
        else
            echo "[init] $mod load failed (may be built-in or missing)"
        fi
    }

    # Block device drivers
    load_module virtio_blk

    # ext4 filesystem (modprobe loads mbcache, jbd2 dependencies automatically)
    load_module ext4

    # FAT/vfat filesystem for EFI partition (modprobe loads fat dependency)
    load_module vfat

    # SCSI/CD-ROM support (for installation media)
    load_module virtio_scsi
    load_module sr_mod  # modprobe loads cdrom dependency

    # ISO 9660 filesystem (to mount installation media)
    load_module isofs
else
    echo "[init] Warning: No kernel modules directory found"
fi

# Create required directories for systemd
/bin/mkdir -p /run/systemd/journal
/bin/mkdir -p /run/systemd/seats
/bin/mkdir -p /run/systemd/sessions
/bin/mkdir -p /run/systemd/users
/bin/mkdir -p /run/systemd/machines
/bin/mkdir -p /run/lock
/bin/mkdir -p /var/log/journal
/bin/mkdir -p /tmp
/bin/chmod 1777 /tmp

# Create /etc/mtab symlink
/bin/ln -sf /proc/self/mounts /etc/mtab

# Check for emergency mode (boot with "emergency" on kernel cmdline)
if grep -q emergency /proc/cmdline; then
    echo ""
    echo "========================================"
    echo "[init] EMERGENCY SHELL"
    echo "========================================"
    echo "[init] Emergency mode requested via kernel cmdline"
    echo "[init] You have a root shell before systemd starts."
    echo "[init] Useful commands:"
    echo "         mount -o remount,rw /      # Make root writable"
    echo "         dmesg | less              # Check kernel messages"
    echo "         exit                      # Continue boot to systemd"
    echo ""
    /bin/bash
    echo "[init] Exiting emergency shell, continuing boot..."
fi

echo "[init] All mounts complete. Handing off to systemd..."
echo "[init] systemd path: /usr/lib/systemd/systemd"
ls -la /usr/lib/systemd/systemd 2>&1 || echo "[init] systemd binary not found!"
ls -la /usr/lib/systemd/systemd-executor 2>&1 || echo "[init] systemd-executor not found!"

# Hand off to systemd
exec /usr/lib/systemd/systemd --system --log-target=console
